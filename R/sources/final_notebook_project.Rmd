# Final Statistic Project Notebook



# What do I want to research? 
Dependent Variables: 
1. bonus_int_national_adjusted
2. gradeexam

Independent Variables:
1. nuts 2
2. nuts3
3. PubPriv
4. examTitle
5. schoolName
6. gender



# 1. Import of Libraries & Connection to MySQL
```{r}
library(ggplot2)
library(RMySQL)
library(tidyr)
library(base)
library(plm)
```
```{r}
# Verbinden Sie sich mit der MySQL-Datenbank
con <- dbConnect(MySQL(),
                 host = "localhost",
                 user = "root",
                 password = "Hausboot69",
                 dbname = "NOVAENES")

dbconn <- dbConnect(MySQL(), host = "localhost", user = "root", password = "Hausboot69", dbname = "NOVAENES");
feed = dbSendQuery(dbconn, "Select * from vwenes")
vwENES <- dbFetch(feed, n = -1)
dbClearResult(feed)
nrow(vwENES)

# Schließen Sie die Verbindung zur MySQL-Datenbank
dbDisconnect(con)
```

# 2. Filter the dataset

```{r}
filtered_df <- data.frame(id=vwENES$ID,
                    schoolName = vwENES$schoolName,
                    District = vwENES$District,
                    PubPriv = vwENES$PubPriv,
                    examTitle = vwENES$examTitle,
                    gender = vwENES$gender,
                    coursename = vwENES$coursename,
                    examyear = vwENES$examyear,
                    bonus_int_vs_national = vwENES$bonus_int_vs_national,
                    bonus_int_national_adjusted = vwENES$bonus_int_national_adjusted,
                    nuts2 = vwENES$NUTS2_NAME,
                    nuts3 = vwENES$NUTS3_NAME, 
                    gradeexam = vwENES$gradeexam)
filtered_df
```


# 3. Plotting for different ideas
a) difference gender & PubPriv
```{r}
# group the data by 'gradeexam' and plot the count of observations in each group
ggplot(filtered_df, aes(x = gradeexam)) +
  stat_bin(aes(y = ..count..))


# Erstelle ein neues Dataframe mit den gruppierten Daten
grouped_gender_pubpriv <- filtered_df %>%
  group_by(examyear, gender, PubPriv) %>%
  summarise(mean_bonus = mean(bonus_int_national_adjusted))
print(grouped_gender_pubpriv)

# Erstelle das Balkendiagramm
ggplot(grouped_gender_pubpriv, aes(x = examyear, y = mean_bonus, fill = gender)) +
  geom_col(position = "dodge") +
  facet_wrap(~ PubPriv)

# Erstelle das Liniendiagramm
ggplot(grouped_gender_pubpriv, aes(x = examyear, y = mean_bonus, color = gender, linetype = PubPriv)) +
  geom_line() +
  scale_linetype_manual(values = c("solid", "dashed"))

# checking if this holds true also for non- adjusted bonus_int_vs_national

# Erstelle ein neues Dataframe mit den gruppierten Daten
grouped_gender_pubpriv_unadj <- filtered_df %>%
  group_by(examyear, gender, PubPriv) %>%
  summarise(mean_bonus_unadjusted = mean(bonus_int_vs_national))


# Erstelle das Liniendiagramm
ggplot(grouped_gender_pubpriv_unadj, aes(x = examyear, y = mean_bonus_unadjusted, color = gender, linetype = PubPriv)) +
  geom_line() +
  scale_linetype_manual(values = c("solid", "dashed"))
```
b) mean_bonus for nuts2 and nuts 3
```{r}
# Group the data by exam year, gender, public/private status, and nuts2
grouped_gender_pubpriv_nuts2 = filtered_df %>%
  group_by(examyear, gender, PubPriv, nuts2) %>%
  summarize(mean_bonus = mean(bonus_int_national_adjusted))

# Create the line plot with facets for each nuts2
ggplot(grouped_gender_pubpriv_nuts2, aes(x = examyear, y = mean_bonus, color = gender, linetype = PubPriv)) +
  geom_line() +
  scale_linetype_manual(values = c("solid", "dashed")) +
  facet_wrap(~ nuts2)

# Group the data by exam year, gender, public/private status, and nuts3
grouped_gender_pubpriv_nuts3 = filtered_df %>%
  group_by(examyear, gender, PubPriv, nuts3) %>%
  summarize(mean_bonus = mean(bonus_int_national_adjusted))

# Create the line plot with facets for each district
ggplot(grouped_gender_pubpriv_nuts3, aes(x = examyear, y = mean_bonus, color = gender, linetype = PubPriv)) +
  geom_line() +
  scale_linetype_manual(values = c("solid", "dashed")) +
  facet_wrap(~ nuts3)
```
c) mean_bonus and mean_gradeexam for examTitle
```{r}
#Sort the exam titles by frequency and get the top 10
top_10_exam_titles = sort(table(filtered_df$examTitle), decreasing = TRUE)[1:8]

#Loop through the top 10 exam titles and print the name and value
for (i in 1:length(top_10_exam_titles)) {
print(paste(names(top_10_exam_titles)[i], ":", top_10_exam_titles[i]))
}

#Get the names of the top 10 exam titles
top_10_exam_titles_names = names(sort(table(filtered_df$examTitle), decreasing = TRUE)[1:8])

#Filter the data frame to only include the top 10 exam titles
filtered_df_top_10_exam_titles = subset(filtered_df, examTitle %in% top_10_exam_titles_names)


# APPLICATION FOR MEAN_BONUS
#Group the data by exam year, gender, public/private status, and exam title
grouped_gender_pubpriv_exam_title_top_10 = filtered_df_top_10_exam_titles %>%
group_by(examyear, gender, PubPriv, examTitle) %>%
summarize(mean_bonus = mean(bonus_int_national_adjusted))

#Create the line plot with facets for each exam title
ggplot(grouped_gender_pubpriv_exam_title_top_10, aes(x = examyear, y = mean_bonus, color = gender, linetype = PubPriv)) +
geom_line() +
scale_linetype_manual(values = c("solid", "dashed")) +
facet_wrap(~ examTitle)

# APPLICATION FOR MEAN_GRADEEXAM
#Group the data by exam year, gender, public/private status, and examTitle
grouped_gradeexam_top_10 = filtered_df_top_10_exam_titles %>%
group_by(examyear, gender, PubPriv, examTitle) %>%
summarize(mean_gradeexam = mean(gradeexam))

#Create the line plot with facets for each exam title
ggplot(grouped_gradeexam_top_10, aes(x = examyear, y = mean_gradeexam, color = gender, linetype = PubPriv)) +
geom_line() +
scale_linetype_manual(values = c("solid", "dashed")) +
facet_wrap(~ examTitle)

```
```{r}
#Fit the pooled OLS model
model_pooled_ols = lm(mean_bonus ~ examyear + gender + PubPriv + examTitle, data = grouped_gender_pubpriv_exam_title_top_10)

#Get the summary of the model
summary(model_pooled_ols)

#Plot the results
ggplot(grouped_gender_pubpriv_exam_title_top_10, aes(x = examyear, y = mean_bonus, color = gender, linetype = PubPriv)) +
geom_line() +
scale_linetype_manual(values = c("solid", "dashed")) +
facet_wrap(~ examTitle) +
geom_smooth(method = "lm", se = FALSE, size = 1.5)


```
```{r}
# Fit the random effects model
pdata_random_fixed <- pdata.frame(filtered_df_top_10_exam_titles, index = c("examyear", "examTitle"))
model_random = plm(mean_bonus ~ gender + PubPriv, data = pdata_random_fixed, model = "random")
summary(model_random)

```


# 4. Models for mean_bonus
a) Pooled OLS
```{r}
# Erstelle Panel-Daten-Modell aus df_filtered
gc()
pdata <- pdata.frame(filtered_df, index = c("examTitle", "examyear"))

# Führe Pooled OLS-Regressionsanalyse durch
model <- plm(bonus_int_national_adjusted ~ gender + PubPriv + nuts2 , data = pdata, model = "pooling")

# Anzeigen der Ergebnisse der Regressionsanalyse
summary(model)
```
b) Fixed & Random Effects
```{r}
#filtered_df<- filtered_df[complete.cases(filtered_df[c("examyear", "examTitle")]),]
#filtered_df<- filtered_df[!duplicated(filtered_df[c("examyear", "examTitle")]), ]

# Creating new panel data for random and fixed effect model
pdata_random_fixed <- pdata.frame(filtered_df, index = c("examyear", "examTitle"))

# fixed effects model
fe_bonus <- plm(bonus_int_national_adjusted ~ gender + PubPriv, model = "within", data=pdata_random_fixed)
summary(fe_bonus)
#model_fixed <- plm(bonus_int_national_adjusted ~ gender + PubPriv, data = pdata_fixed, model = "within")
#summary(pdata_random_fixed)

# random effects model
re_bonus <- plm(bonus_int_national_adjusted ~ gender + PubPriv, model = "random", data=pdata_random_fixed)
summary(re_bonus)
#model_random <- plm(bonus_int_national_adjusted ~ gender + PubPriv, data = pdata_random, model = "random")
#summary(pdata_random_fixed)
```


# 5. Tests for mean_bonus
c) Performing tests in order to know which model to use
```{r}
# Lagrange Multiplier Test (Breusch Pagan), --> H0: No panel effects (use OLS)

# Robust Hausman Test (farina with and without internet), --> H0: Use random effects

# Breusch-Godrey/Wooldridge test for serial correlation --> H0: No serial correlation

# Breusch-Pagan --> H0: Homoskedasticity

# Augmented Dickey- Fuller Test --> H0: Non-stationary

# Robust covariance matrix estimation

```




# 6. Models for mean_gradeexam
# 7. Tests for mean_gradeexam

